<script>
  (function () {
    // ----- Filtering: All vs Selected -----
    var filterContainer = document.getElementById("pub-filters");
    if (filterContainer) {
      var buttons = Array.prototype.slice.call(
        filterContainer.querySelectorAll("[data-filter]")
      );
      var entries = Array.prototype.slice.call(
        document.querySelectorAll(".bib-entry")
      );

      function applyFilter(filter) {
        entries.forEach(function (el) {
          var isSelected = el.getAttribute("data-selected") === "true";
          var topics = (el.getAttribute("data-topics") || "").toLowerCase();
          var show = false;

          if (filter === "all") {
            show = true;
          } else if (filter === "selected") {
            show = isSelected;
          } else {
            // Generic topic-based filter: match on topics tag
            var f = (filter || "").toLowerCase();
            show = topics.indexOf(f) !== -1;
          }

          el.style.display = show ? "" : "none";
        });
      }

      filterContainer.addEventListener("click", function (e) {
        var btn = e.target.closest("[data-filter]");
        if (!btn) return;
        e.preventDefault();
        var filter = btn.getAttribute("data-filter");
        buttons.forEach(function (b) {
          b.classList.toggle("active", b === btn);
        });
        applyFilter(filter);
      });
    }

    // ----- Copy BibTeX buttons -----
    function copyTextToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise(function (resolve, reject) {
        var textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.top = "-1000px";
        document.body.appendChild(textarea);
        textarea.select();
        try {
          var ok = document.execCommand("copy");
          document.body.removeChild(textarea);
          ok ? resolve() : reject(new Error("execCommand failed"));
        } catch (err) {
          document.body.removeChild(textarea);
          reject(err);
        }
      });
    }

    document.addEventListener("click", function (e) {
      var btn = e.target.closest(".copy-bib-btn");
      if (!btn) return;
      e.preventDefault();

      var entry = btn.closest(".bib-entry");
      if (!entry) return;
      
      // Find the hidden BibTeX div (not the button)
      var bibBlock = entry.querySelector(".bibtex.hidden");
      if (!bibBlock) return;

      // Get plain text (strip syntax highlighting markup)
      var text = bibBlock.textContent || "";
      text = text.trim();

      if (!text) return;

      var original = btn.textContent;
      copyTextToClipboard(text)
        .then(function () {
          btn.textContent = "Copied!";
          setTimeout(function () {
            btn.textContent = original;
          }, 1500);
        })
        .catch(function () {
          btn.textContent = "Copy failed";
          setTimeout(function () {
            btn.textContent = original;
          }, 1500);
        });
    });
  })();
</script>


